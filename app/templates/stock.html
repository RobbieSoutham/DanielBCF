{% extends "layout/base.html" %}

{% block head %}
    <link href="{{ url_for('static', filename='css/stock.css') }}" rel="stylesheet" />

    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap.min.js"></script>
    
    <title>Stock</title>
{% endblock %}

{% block content %}

<div class="page-header">
        <nav class = "navbar navbar-expand-lg navbar-light bg-light">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class ="navbar-brand" href="{{ url_for('stock') }}">DanielBCF<br><small class="text-muted">Stock management</small></a>
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="{{ url_for('stock') }}">Stock</a>
                </li>
            </ul>
            <div id="welcome">
                    <span>Hi {{ current_user.first_name }}! </span>
                    <a href="{{ url_for('logout') }}">Logout</a>  
            </div>
        </nav>

    </div>
    <div class="modal" id="modal_init" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Please select a site</h5>
                  </button>
                </div>
                <div class="modal-body">
                  <select id="sites">

                  </select>
                </div>
                <div class="modal-footer">
                  <button onclick="loadSites()" type="button" class="btn btn-primary" data-dismiss="modal">Continue</button>
                </div>
              </div>
            </div>
    </div>
    
    <div class="modal" id="modal_confirm" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                    </button>
                    </div>
                    <div class="modal-body">
                        <h5 class="modal-title">Are you sure you would like to make this change?</h5>
                    </div>
                    <div class="modal-footer">
                      <button id="change" onclick="" type="button" class="btn btn-success" data-dismiss="modal">Yes</button>
                      <button type="button" class="btn btn-danger" data-dismiss="modal">No</button>
                    </div>
                </div>
            </div>
    </div>

<div id="container">
    <table class="table table-striped table-bordered" id="stock">
        <thead>
            <tr>
            <th>Name</th>
            <th>Status</th>
            <th></th>
            </tr>
        </thead>
    </table>
{% endblock %}
{% block scripts %}
<script>
    $(function() {
        status = ""
        stat_class = ""
        
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

        $.ajax({
            type: "GET",
            url: $SCRIPT_ROOT + "sites_list",
            dataType: 'json',
            success: function (data) {
                var html = '';
                $.each(data, function (i, item) {

                    html += "<option value='" + item.id + "'>" + item.name + "</option>"
                });
                $('#sites').append(html);
            }
        });
        $('#modal_init').modal('show');
    });

    function loadSites(){
        site = $("#sites").val();
        $('#modal_init').modal('hide');

        $.ajax({
            type: "GET",
            url: $SCRIPT_ROOT + "stock_list",
            dataType: 'json',
            success: function (data) {
                var html = '';
                status = "";
                $.each(data, function (i, item) {
                    if (item.site_id == site){
                    
                        if (item.stock_healthy == 1){
                            status = "Normal";
                            colour = "#28a745"
                        }
                        else if (items.stock_healthy == 0){
                            status = "Low"
                            colour = "##ffc107"

                        }
                        else{
                            status = "Ordered"
                            colour = "#dc3545"
                        }

                        btns_html = "<center><div class='btn-group' role='group'><button type='button' onclick='confirm(" + item.id + ", false);' class='btn btn-warning'>Low</button><button type='button' onclick='confirm(" + item.id + ", null);' class='btn btn-danger'>Out</button></div></center>"

                        html += "<tr><td>" + item.name + "</td>center><td class='status' style='background-color: " + colour + ";'>" + status + "</td></center><td>" +  btns_html;
                    }
                });
                $('#stock').append(html);
            }
        });

    }
    function confirm(id, type){
        $("#change").attr("onclick","set_out(" + id + ", " + type +")");
        
        
        $('#change').value = id
        $('#modal_confirm').modal('show');
    }

    function set_stock(id, type){
        $.ajax({
            type: 'POST',
            url: '../portal/curriculum.php',
            data: [],
            success: function(data)
            {
            $('#stock').html(data);
            }
        });
        
        }
        function set_out(id) {

        }
</script>
{% endblock %}

{% block footer %}
    {% include "include/footer.html" %}
{% endblock %}
